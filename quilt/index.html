<html>
  <body>
    <script src="../javascripts/cbor.min.js" type="text/javascript"></script>
    <script src="../javascripts/HoloPlayClient.js" type="text/javascript"></script>
    <script>

      (function() {

      var client;
      function loadExampleQuilt(quiltUrl, vx, vy, vt, a, ov) {
        function imDone(quiltUrl) {
          window.location.href = quiltUrl;
        }
        var xhttp = new XMLHttpRequest();
        xhttp.responseType = 'arraybuffer';
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              var showCmd = new ShowMessage({"vx":vx,"vy":vy}, new Uint8Array(this.response));
              console.log(showCmd);
              if (vt != null) showCmd["cmd"].show.quilt.settings["vtotal"]=vt;
              if (ov != null) showCmd["cmd"].show.quilt.settings["overscan"]=ov;
              if (a != null) showCmd["cmd"].show.quilt.settings["aspect"]=a;
              client.sendMessage(showCmd, 10).then(function(){imDone(quiltUrl)});
            } 
          }
        };
        xhttp.open("GET", quiltUrl, true);
        xhttp.send();
      }

        var urlParams = new URLSearchParams(window.location.search);

        function oninit(resp)
        {
          if (resp.devices[0].state == 'ok' || resp.devices[0].state == 'hidden'){
           loadExampleQuilt(urlParams.get('q'), urlParams.get('vx'), urlParams.get('vy'), urlParams.get('vt'), urlParams.get('a'), urlParams.get('ov')); 
          } else {
            window.location.href = urlParams.get('q');
          }
        }
        if (urlParams.has('q'))
        {
          client = new HoloPlayClient(oninit, null, null, false, "a", false, "none");
        }
      })();

    </script>

  </body>
</html>
